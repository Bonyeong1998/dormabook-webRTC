<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>도르마북 | 학습실</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>
<body>
<header class="w3-container" style="padding: 0; height: 60px;">
  <div style="width:12%; height: 100%; border-right: solid 1px #d5dadb; border-bottom: solid 1px #d5dadb; float: left; text-align: center;">
    <h2 style="font-family: 'Noto Sans KR', sans-serif;">도르마북</h2>
  </div>

  <div style="width:88%; height: 100%; border-right: solid 1px #d5dadb; border-bottom: solid 1px #d5dadb; float: left; padding-left: 50px;">
    <h2 id="title" style="font-family: 'Noto Sans KR', sans-serif;">학습 채팅방</h2>
  </div>
</header>
<!-- Left SideBar-->
<div class="w3-sidebar w3-bar-block"
     style="width:12%; border-right: solid 1px #d5dadb; font-family: 'Noto Sans KR', sans-serif; padding-left: 10px">
  <a id="chat-btn" class="w3-bar-item w3-button">학습 채팅방</a>
  <a id="report-btn" class="w3-bar-item w3-button">보고서 관리</a>
  <a id="score-btn" class="w3-bar-item w3-button">성적 제출</a>
</div>

<!-- Right SideBar-->
<div class="w3-sidebar w3-bar-block w3-xxlarge"
     style="max-width:4%; min-width:60px; position:absolute; right:0; float:right; border-left: solid 1px #d2d2d2;">
  <svg id="cam-chat" class="w3-bar-item w3-button" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
    <circle cx="20" cy="20" r="20" fill="#F2F4F8"/>
    <path fill-rule="evenodd" clip-rule="evenodd"
          d="M10 16.4C10 15.7635 10.2634 15.153 10.7322 14.7029C11.2011 14.2529 11.837 14 12.5 14H21.875C22.4814 13.9999 23.0671 14.2114 23.5231 14.5951C23.9791 14.9788 24.2743 15.5085 24.3537 16.0856L28.2413 14.4272C28.4315 14.3458 28.64 14.3114 28.8477 14.327C29.0554 14.3426 29.2557 14.4078 29.4304 14.5167C29.6052 14.6255 29.7488 14.7746 29.8483 14.9503C29.9478 15.126 29.9999 15.3228 30 15.5228V24.4772C29.9998 24.677 29.9477 24.8737 29.8483 25.0492C29.7488 25.2248 29.6053 25.3738 29.4308 25.4826C29.2562 25.5914 29.0561 25.6567 28.8486 25.6724C28.641 25.6882 28.4327 25.6539 28.2425 25.5728L24.3537 23.9144C24.2743 24.4915 23.9791 25.0212 23.5231 25.4049C23.0671 25.7886 22.4814 26.0001 21.875 26H12.5C11.837 26 11.2011 25.7471 10.7322 25.2971C10.2634 24.847 10 24.2365 10 23.6V16.4ZM24.375 22.61L28.75 24.4772V15.5228L24.375 17.39V22.61ZM12.5 15.2C12.1685 15.2 11.8505 15.3264 11.6161 15.5515C11.3817 15.7765 11.25 16.0817 11.25 16.4V23.6C11.25 23.9183 11.3817 24.2235 11.6161 24.4485C11.8505 24.6736 12.1685 24.8 12.5 24.8H21.875C22.2065 24.8 22.5245 24.6736 22.7589 24.4485C22.9933 24.2235 23.125 23.9183 23.125 23.6V16.4C23.125 16.0817 22.9933 15.7765 22.7589 15.5515C22.5245 15.3264 22.2065 15.2 21.875 15.2H12.5Z"
          fill="black"/>
  </svg>
</div>

<div id = "chatroom" style = "overflow-y: auto; width:84%; height: 750px; margin-left: 12%;">
</div>

<div id="chat-bar"
     style="width : 84%; height: 15%; position: absolute; bottom: 0; border-top: solid 1px #d5dadb; margin-left: 12%; padding: 0.5%">
  <div style="width: 100%; height: 100%; border: 1px solid #00C473; border-radius:10px">
        <textarea
                id="message" style="width: 100%; height: 100%; border: none; border-radius:10px; resize: none; padding: 10px"></textarea>
    <button type="button" class="btn btn-outline-dark" id="send"
            style="position: absolute; right: 1.5%; bottom: 15%; border: none; background-color: #F2F4F8">전송
    </button>
    <svg width="18" height="20" viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg"
         style="position: absolute; left: 1.5%; bottom: 15%;">
      <path d="M1.88255 18.1698C4.39083 20.6101 8.47544 20.6101 10.9811 18.1698L17.9307 11.4138C17.976 11.3697 18 11.3101 18 11.248C18 11.1858 17.976 11.1262 17.9307 11.0822L16.9482 10.1263C16.9033 10.0828 16.8425 10.0584 16.7791 10.0584C16.7157 10.0584 16.6549 10.0828 16.61 10.1263L9.66035 16.8823C8.79763 17.7217 7.64999 18.1828 6.43047 18.1828C5.21095 18.1828 4.06331 17.7217 3.20326 16.8823C2.34054 16.043 1.86657 14.9265 1.86657 13.7426C1.86657 12.5562 2.34054 11.4423 3.20326 10.6029L10.2861 3.71479L11.4337 2.59828C12.5068 1.5543 14.2509 1.5543 15.3239 2.59828C15.8432 3.10343 16.1281 3.77437 16.1281 4.48935C16.1281 5.20433 15.8432 5.87527 15.3239 6.38042L8.29703 13.2142C8.11863 13.3851 7.88431 13.481 7.63402 13.481H7.63136C7.38106 13.481 7.1494 13.3851 6.97367 13.2142C6.79526 13.0406 6.6994 12.8126 6.6994 12.5691C6.6994 12.3282 6.79793 12.1003 6.97367 11.9293L12.7171 6.34674C12.7624 6.3027 12.7864 6.24312 12.7864 6.18095C12.7864 6.11877 12.7624 6.05919 12.7171 6.01515L11.7346 5.05926C11.6897 5.01576 11.6289 4.99133 11.5655 4.99133C11.5021 4.99133 11.4413 5.01576 11.3964 5.05926L5.65562 10.6444C5.12574 11.1599 4.8355 11.8438 4.8355 12.5717C4.8355 13.2997 5.1284 13.9861 5.65562 14.4991C6.75 15.5638 8.52869 15.5612 9.62307 14.4991L10.3047 13.8333L16.6473 7.66531C17.0778 7.24896 17.419 6.75361 17.6512 6.20798C17.8834 5.66235 18.002 5.0773 18 4.48676C18 3.28735 17.518 2.16048 16.6473 1.31339C15.7447 0.437796 14.5624 0 13.3802 0C12.1979 0 11.0157 0.437796 10.1157 1.31339L1.88255 9.31805C0.671013 10.4993 9.53674e-06 12.0718 9.53674e-06 13.7426C-0.00265312 15.4161 0.66835 16.9885 1.88255 18.1698Z"
            fill="black"/>
    </svg>
  </div>
</div>
</div>

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
</body>
<script th:inline = "javascript">

  /*<![CDATA[*/
  var nickname = [[${sub}]];
  var roomAddr = [[${roomAddr}]];
  var roomNo = [[${roomNo}]];
  var token = [[${accessToken}]];
  /*]]>*/

  sessionStorage.setItem('jwt', token);

  $(document).ready(function($) {
    currentDate = new Date();
    var year = currentDate.getFullYear();
    var month = currentDate.getMonth() + 1;
    var date = currentDate.getDate();

    $.ajax({
      url: "/api/chat/team-chat/" + roomNo,
      type: "get",
      contentType : 'application/json; charset=UTF-8',
      beforeSend: function (xhr) {
        xhr.setRequestHeader("Authorization", token);
      },
      success: function(data) {
        loadChat(data);
      },
      error: function() {
      },
      async: false
    })
  });

  var webSocket;
  var isScrollUp = false;
  var currentDate;

  connect();

  document.getElementById("send").addEventListener("click",function(){
    if(document.getElementById("message").value.replace(/\s|　/gi, "").length !== 0) {
      insertChat();
      send();
    } else {
      document.getElementById("message").value = "";
    }
  })

  document.getElementById("message").addEventListener("keydown", function (){
    if (event.keyCode == 13)
      if (!event.shiftKey){
        event.preventDefault();
        if(document.getElementById("message").value.replace(/\s|　/gi, "").length !== 0) {
          insertChat();
          send();
        } else {
          document.getElementById("message").value = "";
        }
      }
  })

  function loadChat(data) {
    var loadYear;
    var loadMonth;
    var loadDate;
    var lastDay;

    for(var i = 0; i < data.length; i++){
      let chatDiv = document.createElement('div');
      let chatDate = document.createElement('div');
      let chatLog = document.createElement('div');
      let byDateDiv = document.createElement('div');
      let byDateContent = document.createElement('div');

      var divStyle = "display: block; width: 60%;";
      var dateStyle = "display: inline-block; color: #AAAAAA; margin-left: 3px; margin-right: 3px;";
      var contentStyle = "display: inline-block; border-radius: 15px; padding: 7px 15px; margin-bottom: 10px; margin-top: 5px; background-color: #F2F2F2; color: black; max-width: 700px;";
      var byDateDivStyle = "display: flex; justify-content: center; width: 100%; margin-bottom: 10px; margin-top: 5px;";
      var byDateContentStyle = "display: inline-block; border-radius: 15px; padding: 7px 15px; background-color: #F2F2F2; color: black;";

      byDateDiv.setAttribute("style", byDateDivStyle);
      byDateContent.setAttribute("style", byDateContentStyle);

      var createdAt = new Date(Date.parse(data[i].chatCreatedat));
      loadYear = createdAt.getFullYear();
      loadMonth = createdAt.getMonth() + 1;
      loadDate = createdAt.getDate();

      if(i === 0) {
        byDateContent.innerText = loadYear + "년 " + loadMonth + "월 " + loadDate + "일";
        byDateDiv.appendChild(byDateContent);
        document.getElementById('chatroom').appendChild(byDateDiv);
        var ld = loadYear+'-'+loadMonth+'-'+loadDate;
        lastDay = new Date(ld);
      } else{
        var nd = loadYear+'-'+loadMonth+'-'+loadDate;
        var newDay = new Date(nd);

        if(lastDay.getTime() !== newDay.getTime()) {
          byDateContent.innerText = loadYear + "년 " + loadMonth + "월 " + loadDate + "일";
          byDateDiv.appendChild(byDateContent);
          document.getElementById('chatroom').appendChild(byDateDiv);
          lastDay = newDay;
        }
      }

      var hours = createdAt.getHours();
      var minutes = createdAt.getMinutes();
      var ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      var strTime = ampm + ' ' + hours + ':' + minutes;

      chatDate.innerText = strTime;
      chatLog.innerText = data[i].chatContent;

      if (data[i].chatMemberid == nickname) {
        divStyle += "text-align: right; float: right;"
        contentStyle += "margin-right: 10px"
        chatDiv.appendChild(chatDate);
        chatDiv.appendChild(chatLog);
      } else {
        divStyle += "text-align: left; float: left;"
        contentStyle += "margin-left: 10px"
        chatDiv.appendChild(chatLog);
        chatDiv.appendChild(chatDate);
      }

      chatDiv.setAttribute("style", divStyle);
      chatDate.setAttribute("style", dateStyle);
      chatLog.setAttribute("style", contentStyle);

      document.getElementById('chatroom').appendChild(chatDiv);
      if(i === data.length-1) {
        var today = new Date();
        if(lastDay.getTime() !== today.getTime()) {
          byDateContent.innerText = today.getFullYear() + "년 " + (today.getMonth()+1) + "월 " + today.getDate() + "일";
          byDateDiv.appendChild(byDateContent);
          document.getElementById('chatroom').appendChild(byDateDiv);
          lastDay = today;
        }
      }
    }
    $('#chatroom').animate({
      scrollTop: chatroom.scrollHeight - chatroom.clientHeight
    }, 100);
  }

  function insertChat(){
    var msg = document.getElementById("message").value;
    $.ajax({
      url: "/api/chat/team-chat",
      beforeSend: function (xhr) {
        xhr.setRequestHeader("Authorization", token);
      },
      type: "post",
      contentType : 'application/json; charset=UTF-8',
      data: JSON.stringify({
        chatMemberid : nickname,
        chatContent : msg,
        studyroomNo : roomNo
      }),
      datatype: "json"
    })
  }

  function updateDate(){
    var newCurDate = new Date();

    var newYear = newCurDate.getFullYear();
    var newMonth = newCurDate.getMonth() + 1;
    var newDate = newCurDate.getDate();

    if(currentDate.getDate() < newDate) {
      let curDateDiv = document.createElement('div');
      let curDate = document.createElement('div');
      curDateDiv.setAttribute("style", "display: flex; justify-content: center; width: 100%; margin-bottom: 10px; margin-top: 5px;");
      curDate.setAttribute("style", "display: inline-block; border-radius: 15px; padding: 7px 15px; background-color: #F2F2F2; color: black;");
      curDate.innerText = newYear + "년 " + newMonth + "월 " + newDate + "일";
      curDateDiv.appendChild(curDate);
      document.getElementById('chatroom').appendChild(curDateDiv);
      currentDate = newCurDate;
    }
  }

  function connect(){
    webSocket = new WebSocket("wss://" + window.location.host + "/chat");
    webSocket.onopen = onOpen;
    webSocket.onclose = onClose;
    webSocket.onmessage = onMessage;
  }
  function disconnect(){
    webSocket.send(JSON.stringify({chatRoomId : roomAddr,type:'LEAVE',chatMemberid:nickname}));
    webSocket.close();
  }
  function send(){
    msg = document.getElementById("message").value;
    webSocket.send(JSON.stringify({chatRoomId : roomAddr,type:'CHAT',chatMemberid:nickname,chatContent : msg}));
    document.getElementById("message").value = "";
  }
  function onOpen(){
    webSocket.send(JSON.stringify({chatRoomId : roomAddr,type:'ENTER',chatMemberid:nickname}));
  }
  function onMessage(e){
    updateDate();
    let json = JSON.parse(e.data);
    let chatDiv = document.createElement('div');
    let chatDate = document.createElement('div');
    let chatLog = document.createElement('div');

    var divStyle = "display: block; width: 60%;";
    var dateStyle = "display: inline-block; color: #AAAAAA; margin-left: 3px; margin-right: 3px";
    var contentStyle = "display: inline-block; border-radius: 15px; padding: 7px 15px; margin-bottom: 10px; margin-top: 5px; background-color: #F2F2F2; color: black; max-width: 700px;";

    var createdAt = new Date(Date.parse(json.chatCreatedat));
    var hours = createdAt.getHours();
    var minutes = createdAt.getMinutes();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    minutes = minutes < 10 ? '0'+minutes : minutes;
    var strTime = ampm + ' ' + hours + ':' + minutes;

    chatDate.innerText = strTime;
    chatLog.innerText = json.chatContent;

    if(json.chatMemberid == nickname) {
      divStyle += "text-align: right; float: right;"
      contentStyle += "margin-right: 10px"
      chatDiv.appendChild(chatDate);
      chatDiv.appendChild(chatLog);
    } else {
      divStyle += "text-align: left; float: left;"
      contentStyle += "margin-left: 10px"
      chatDiv.appendChild(chatLog);
      chatDiv.appendChild(chatDate);
    }

    chatDiv.setAttribute("style", divStyle);
    chatDate.setAttribute("style", dateStyle);
    chatLog.setAttribute("style", contentStyle);

    document.getElementById('chatroom').appendChild(chatDiv);
    isScrollUp = false;

    // 스크롤 발생 시 최하단으로 자동 스크롤
    var chatroom = document.getElementById('chatroom');
    if (!isScrollUp) {
      $('#chatroom').animate({
        scrollTop: chatroom.scrollHeight - chatroom.clientHeight
      }, 100);
      isScrollUp = true;
    }
  }

  function onClose(){
    disconnect();
  }

  window.addEventListener('beforeunload', (event) => {
    event.preventDefault();
    disconnect();
  });
</script>
</html>